<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32æœºæ¢°è‡‚æ§åˆ¶</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
    h1 { color: #333; text-align: center; margin-bottom: 30px; }
    .container { max-width: 1000px; margin: 0 auto; background-color: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 5px; }
    .row { display: flex; flex-wrap: wrap; margin-bottom: 20px; }
    .col { flex: 1; padding: 10px; min-width: 300px; }
    .slider-container { margin-bottom: 15px; }
    .slider-container label { display: block; margin-bottom: 5px; font-weight: bold; }
    .slider-value { display: inline-block; width: 40px; text-align: right; }
    input[type=range] { width: 80%; vertical-align: middle; }
    button { background-color: #4CAF50; border: none; color: white; padding: 10px 15px; text-align: center; text-decoration: none; display: inline-block; font-size: 14px; margin: 4px 2px; cursor: pointer; border-radius: 4px; }
    button:disabled { background-color: #cccccc; opacity: 0.6; cursor: not-allowed; }
    .btn-warning { background-color: #ff9800; }
    .btn-danger { background-color: #f44336; }
    .btn-info { background-color: #2196F3; }
    .btn-success { background-color: #4CAF50; }
    .status { padding: 10px; background-color: #e8f5e9; margin-top: 20px; border-radius: 4px; }
    .tab { overflow: hidden; border: 1px solid #ccc; background-color: #f1f1f1; }
    .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; }
    .tab button:hover { background-color: #ddd; }
    .tab button.active { background-color: #ccc; }
    .tabcontent { display: none; padding: 6px 12px; border: 1px solid #ccc; border-top: none; animation: fadeEffect 1s; }
    @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }
    .path-list { margin-top: 20px; }
    .path-item { 
      padding: 15px; 
      margin-bottom: 10px; 
      background-color: #f8f9fa; 
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex; 
      flex-direction: column;
      transition: all 0.2s ease;
    }
    .path-item:hover {
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }
    .path-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .path-title {
      font-weight: bold;
      font-size: 16px;
      display: flex;
      align-items: center;
    }
    .path-status {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .path-status.empty {
      background-color: #e0e0e0;
    }
    .path-status.exists {
      background-color: #4CAF50;
    }
    .path-info {
      margin: 10px 0;
      font-size: 14px;
      color: #666;
    }
    .path-actions { 
      display: flex; 
      justify-content: flex-end;
      margin-top: 10px;
    }
    .path-actions button { 
      margin-left: 8px; 
      padding: 6px 12px;
      display: flex;
      align-items: center;
    }
    .path-actions button i {
      margin-right: 5px;
    }
    .path-preview {
      height: 0;
      overflow: hidden;
      transition: height 0.3s ease;
      background-color: #f0f0f0;
      border-radius: 4px;
      margin-top: 10px;
    }
    .path-preview.active {
      height: auto;
      padding: 10px;
    }
    .path-preview pre {
      margin: 0;
      white-space: pre-wrap;
      font-size: 12px;
    }
    .file-upload-container {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      border-radius: 8px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    .file-upload-container:hover {
      border-color: #2196F3;
      background-color: #f0f8ff;
    }
    .file-upload-container.drag-over {
      border-color: #4CAF50;
      background-color: #e8f5e9;
    }
    .file-upload-icon {
      font-size: 48px;
      color: #757575;
      margin-bottom: 10px;
    }
    .file-upload-text {
      margin-bottom: 15px;
      color: #555;
    }
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    .file-input-wrapper input[type=file] {
      opacity: 0;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    .file-input-button {
      display: inline-block;
      padding: 8px 16px;
      background-color: #2196F3;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .selected-file {
      margin-top: 10px;
      font-style: italic;
      color: #666;
    }
    .path-management-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .path-management-header h3 {
      margin: 0;
    }
    .refresh-button {
      padding: 5px 10px;
      font-size: 12px;
    }
    .status-indicator { 
      text-align: center; 
      margin: 15px 0; 
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 4px;
    }
    .status-badge { 
      padding: 5px 10px; 
      border-radius: 20px; 
      font-weight: bold;
      display: inline-block;
      min-width: 80px;
    }
    .status-active {
      background-color: #e8f5e9; 
      color: #2e7d32;
    }
    .status-inactive {
      background-color: #f5f5f5; 
      color: #757575;
    }
    .path-select-container { 
      text-align: center; 
      padding: 15px;
      background-color: #f0f8ff;
      border-radius: 5px;
    }
    .path-select {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin: 0 10px;
      min-width: 120px;
    }
    .icon { 
      margin-right: 5px; 
      font-weight: bold;
    }
    .loading-indicator {
      text-align: center;
      padding: 20px;
      color: #757575;
      font-style: italic;
    }
    .empty-message {
      text-align: center;
      padding: 30px;
      color: #757575;
      font-style: italic;
      background-color: #f5f5f5;
      border-radius: 8px;
    }
    .error-message {
      text-align: center;
      padding: 20px;
      color: #c62828;
      background-color: #ffebee;
      border-radius: 8px;
      margin: 15px 0;
    }
    .path-info-panel {
      margin-top: 30px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border-left: 3px solid #2196F3;
    }
    .path-info-panel h4 {
      margin-top: 0;
      color: #2196F3;
    }
    .path-info-panel pre {
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .upload-options {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 15px;
    }
    #status-message {
      padding: 10px;
      margin-top: 15px;
      border-radius: 5px;
      display: none;
    }
    .success {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    .error {
      background-color: #ffebee;
      color: #c62828;
    }
    /* æ¨¡å¼æŒ‰é’®å®¹å™¨æ ·å¼ */
    .mode-buttons {
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
    }
    .mode-buttons button {
      margin: 0 10px;
      min-width: 120px;
    }
    /* æ§åˆ¶æŒ‰é’®å®¹å™¨æ ·å¼ */
    .control-buttons {
      margin-top: 20px;
    }
    .control-container {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
      border-left: 5px solid #4CAF50;
    }
    .control-container.active {
      display: block;
      animation: fadeIn 0.5s;
    }
    .control-container h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .button-group {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin-bottom: 20px;
    }
    .button-group button {
      min-width: 120px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .button-group button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .button-group button:active {
      transform: translateY(1px);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ESP32æœºæ¢°è‡‚æ§åˆ¶</h1>
    
    <div class="tab">
      <button class="tablinks active" onclick="openTab(event, 'control')">å®æ—¶æ§åˆ¶</button>
      <button class="tablinks" onclick="openTab(event, 'learning')">å­¦ä¹ æ¨¡å¼</button>
      <button class="tablinks" onclick="openTab(event, 'paths')">è·¯å¾„ç®¡ç†</button>
    </div>
    
    <div id="control" class="tabcontent" style="display:block;">
      <h2>å®æ—¶å…³èŠ‚æ§åˆ¶</h2>
      <div class="row">
        <div class="col">
          <div class="slider-container">
            <label>åº•åº§ <span id="baseValue" class="slider-value">0</span>Â°</label>
            <input type="range" id="baseSlider" min="0" max="180" value="90" oninput="updateSlider('base', this.value)">
          </div>
          <div class="slider-container">
            <label>è‚©éƒ¨ <span id="shoulderValue" class="slider-value">0</span>Â°</label>
            <input type="range" id="shoulderSlider" min="0" max="180" value="90" oninput="updateSlider('shoulder', this.value)">
          </div>
          <div class="slider-container">
            <label>è‚˜éƒ¨ <span id="elbowValue" class="slider-value">0</span>Â°</label>
            <input type="range" id="elbowSlider" min="0" max="180" value="90" oninput="updateSlider('elbow', this.value)">
          </div>
          <div class="slider-container">
            <label>è…•éƒ¨ <span id="wristValue" class="slider-value">0</span>Â°</label>
            <input type="range" id="wristSlider" min="0" max="180" value="90" oninput="updateSlider('wrist', this.value)">
          </div>
          <div class="slider-container">
            <label>å¤¹çˆª <span id="gripperValue" class="slider-value">0</span>Â°</label>
            <input type="range" id="gripperSlider" min="0" max="90" value="45" oninput="updateSlider('gripper', this.value)">
          </div>
        </div>
        <div class="col">
          <button onclick="sendHome()" class="btn-info">å›åˆ°åŸä½</button>
          <button onclick="refreshStatus()" class="btn-info">åˆ·æ–°çŠ¶æ€</button>
          <div class="status" id="armStatus">
            <h3>æœºæ¢°è‡‚çŠ¶æ€</h3>
            <p>åº•åº§: <span id="currentBase">--</span>Â°</p>
            <p>è‚©éƒ¨: <span id="currentShoulder">--</span>Â°</p>
            <p>è‚˜éƒ¨: <span id="currentElbow">--</span>Â°</p>
            <p>è…•éƒ¨: <span id="currentWrist">--</span>Â°</p>
            <p>å¤¹çˆª: <span id="currentGripper">--</span>Â°</p>
            <p>æ¨¡å¼: <span id="currentMode">--</span></p>
            <p>å½•åˆ¶çŠ¶æ€: <span id="isRecording">--</span></p>
            <p>å›æ”¾çŠ¶æ€: <span id="isPlaying">--</span></p>
          </div>
        </div>
      </div>
    </div>
    
    <div id="learning" class="tabcontent">
      <h2>å­¦ä¹ æ¨¡å¼æ§åˆ¶</h2>
      
      <!-- æ¨¡å¼é€‰æ‹©æŒ‰é’® -->
      <div class="mode-buttons">
        <button id="modeManual" onclick="setMode(0)" class="btn-info">æ‰‹åŠ¨æ¨¡å¼</button>
        <button id="modeRecord" onclick="setMode(1)" class="btn-warning">å½•åˆ¶æ¨¡å¼</button>
        <button id="modePlayback" onclick="setMode(2)" class="btn-info">å›æ”¾æ¨¡å¼</button>
      </div>
      
      <!-- æ‰‹åŠ¨æ¨¡å¼æ§åˆ¶é¢æ¿ -->
      <div id="manualControls" class="control-container">
        <h3>æ‰‹åŠ¨æ§åˆ¶æ¨¡å¼</h3>
        <p>åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œæ‚¨å¯ä»¥é€šè¿‡å®æ—¶æ§åˆ¶é¡µé¢çš„æ»‘å—æ§åˆ¶æœºæ¢°è‡‚ã€‚</p>
        <p>æˆ–ä½¿ç”¨ç”µä½å™¨æ‰‹åŠ¨æ§åˆ¶æœºæ¢°è‡‚ä½ç½®ã€‚</p>
      </div>
      
      <!-- å½•åˆ¶æ¨¡å¼æ§åˆ¶é¢æ¿ -->
      <div id="recordControls" class="control-container">
        <h3>å½•åˆ¶æ§åˆ¶</h3>
        <div class="row">
          <div class="col">
            <div class="button-group">
              <button id="startRecording" onclick="startRecording()" class="btn-success">
                <i class="icon">â—</i> å¼€å§‹å½•åˆ¶
              </button>
              <button id="stopRecording" onclick="stopRecording()" class="btn-danger">
                <i class="icon">â– </i> åœæ­¢å½•åˆ¶
              </button>
            </div>
            <div class="status-indicator">
              <p>å½•åˆ¶çŠ¶æ€: <span id="recordingStatus" class="status-badge">æœªå¼€å§‹</span></p>
            </div>
          </div>
          <div class="col">
            <div class="path-select-container">
              <label for="recordPathIndexSelect">ä¿å­˜åˆ°è·¯å¾„ç´¢å¼•:</label>
              <select id="recordPathIndexSelect" class="path-select">
                <option value="0">è·¯å¾„ 0</option>
                <option value="1">è·¯å¾„ 1</option>
                <option value="2">è·¯å¾„ 2</option>
                <option value="3">è·¯å¾„ 3</option>
                <option value="4">è·¯å¾„ 4</option>
              </select>
              <button onclick="savePath()" class="btn-info">
                <i class="icon">ğŸ’¾</i> ä¿å­˜è·¯å¾„
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- å›æ”¾æ¨¡å¼æ§åˆ¶é¢æ¿ -->
      <div id="playbackControls" class="control-container">
        <h3>å›æ”¾æ§åˆ¶</h3>
        <div class="row">
          <div class="col">
            <div class="button-group">
              <button id="startPlayback" onclick="startPlayback()" class="btn-success">
                <i class="icon">â–¶</i> å¼€å§‹å›æ”¾
              </button>
              <button id="stopPlayback" onclick="stopPlayback()" class="btn-danger">
                <i class="icon">â– </i> åœæ­¢å›æ”¾
              </button>
            </div>
            <div class="status-indicator">
              <p>å›æ”¾çŠ¶æ€: <span id="playbackStatus" class="status-badge">æœªå¼€å§‹</span></p>
            </div>
          </div>
          <div class="col">
            <div class="path-select-container">
              <label for="playbackPathIndexSelect">é€‰æ‹©å›æ”¾è·¯å¾„:</label>
              <select id="playbackPathIndexSelect" class="path-select">
                <option value="0">è·¯å¾„ 0</option>
                <option value="1">è·¯å¾„ 1</option>
                <option value="2">è·¯å¾„ 2</option>
                <option value="3">è·¯å¾„ 3</option>
                <option value="4">è·¯å¾„ 4</option>
              </select>
              <button onclick="loadPath()" class="btn-info">
                <i class="icon">ğŸ“‚</i> åŠ è½½è·¯å¾„
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="paths" class="tabcontent">
      <h2>è·¯å¾„æ–‡ä»¶ç®¡ç†</h2>
      <div class="row">
        <div class="col">
          <div class="path-management-header">
            <h3>å¯ç”¨è·¯å¾„</h3>
            <button onclick="updatePathList()" class="btn-info refresh-button">
              <i class="icon">ğŸ”„</i> åˆ·æ–°
            </button>
          </div>
          <div class="path-list" id="pathList">
            <!-- è·¯å¾„é¡¹ç›®ä¼šåœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
            <div class="loading-indicator">åŠ è½½ä¸­...</div>
          </div>
        </div>
        <div class="col">
          <h3>ä¸Šä¼ è·¯å¾„æ–‡ä»¶</h3>
          <div class="file-upload-container" id="dropZone">
            <div class="file-upload-icon">ğŸ“</div>
            <div class="file-upload-text">æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ–‡ä»¶</div>
            <div class="file-input-wrapper">
              <div class="file-input-button">é€‰æ‹©æ–‡ä»¶</div>
              <input type="file" id="pathFile" accept=".json" onchange="handleFileSelect(event)">
            </div>
            <div class="selected-file" id="selectedFileName"></div>
          </div>
          
          <div class="upload-options">
            <div class="form-group">
              <label for="uploadPathIndex">ä¸Šä¼ åˆ°è·¯å¾„ç´¢å¼•:</label>
              <select id="uploadPathIndex" class="path-select">
                <option value="0">è·¯å¾„ 0</option>
                <option value="1">è·¯å¾„ 1</option>
                <option value="2">è·¯å¾„ 2</option>
                <option value="3">è·¯å¾„ 3</option>
                <option value="4">è·¯å¾„ 4</option>
              </select>
            </div>
            <button onclick="uploadPathFile()" class="btn-info" id="uploadButton" disabled>
              <i class="icon">â¬†ï¸</i> ä¸Šä¼ æ–‡ä»¶
            </button>
          </div>
          
          <div class="path-info-panel">
            <h4>è·¯å¾„æ–‡ä»¶æ ¼å¼è¯´æ˜</h4>
            <p>è·¯å¾„æ–‡ä»¶æ˜¯JSONæ ¼å¼ï¼ŒåŒ…å«ä»¥ä¸‹ç»“æ„ï¼š</p>
            <pre>{
  "path_index": 0,
  "point_count": 10,
  "total_time_ms": 5000,
  "points": [
    {
      "timestamp": 0,
      "angles": {
        "base": 90,
        "shoulder": 90,
        "elbow": 90,
        "wrist": 90,
        "gripper": 45
      }
    },
    ...
  ]
}</pre>
          </div>
        </div>
      </div>
    </div>
    
    <div id="status-message"></div>
  </div>
  
  <script>
    let sliderChangeTimeout = null;
    let currentMode = 0;
    
    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    window.onload = function() {
      // åˆå§‹åŒ–çŠ¶æ€
      refreshStatus();
      
      // åˆå§‹åŒ–è·¯å¾„åˆ—è¡¨ï¼Œæ·»åŠ é‡è¯•æœºåˆ¶
      updatePathList(true);
      
      // åˆå§‹åŒ–æ‹–æ”¾åŠŸèƒ½
      initDragAndDrop();
      
      // æ·»åŠ è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
      setInterval(function() {
        refreshStatus();
      }, 2000); // æ¯2ç§’åˆ·æ–°ä¸€æ¬¡
    };
    
    function openTab(evt, tabName) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
      
      // å¦‚æœåˆ‡æ¢åˆ°è·¯å¾„ç®¡ç†ï¼Œåˆ·æ–°è·¯å¾„åˆ—è¡¨
      if (tabName === 'paths') {
        updatePathList();
      }
    }
    
    function updateSlider(joint, value) {
      document.getElementById(joint + 'Value').textContent = value;
      
      // æ§åˆ¶é€Ÿç‡ï¼Œé¿å…é¢‘ç¹å‘é€è¯·æ±‚
      if (sliderChangeTimeout) {
        clearTimeout(sliderChangeTimeout);
      }
      
      sliderChangeTimeout = setTimeout(function() {
        let data = {};
        data[joint] = parseInt(value);
        sendControlCommand(data);
      }, 100);
    }
    
    function sendControlCommand(data) {
      fetch('/api/control', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          showMessage('æ§åˆ¶å‘½ä»¤å¤±è´¥', false);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('é€šä¿¡é”™è¯¯: ' + error, false);
      });
    }
    
    function refreshStatus() {
      fetch('/api/status')
      .then(response => response.json())
      .then(data => {
        document.getElementById('currentBase').textContent = data.base;
        document.getElementById('currentShoulder').textContent = data.shoulder;
        document.getElementById('currentElbow').textContent = data.elbow;
        document.getElementById('currentWrist').textContent = data.wrist;
        document.getElementById('currentGripper').textContent = data.gripper;
        
        // æ›´æ–°æ»‘å—ä½ç½®
        document.getElementById('baseSlider').value = data.base;
        document.getElementById('shoulderSlider').value = data.shoulder;
        document.getElementById('elbowSlider').value = data.elbow;
        document.getElementById('wristSlider').value = data.wrist;
        document.getElementById('gripperSlider').value = data.gripper;
        
        document.getElementById('baseValue').textContent = data.base;
        document.getElementById('shoulderValue').textContent = data.shoulder;
        document.getElementById('elbowValue').textContent = data.elbow;
        document.getElementById('wristValue').textContent = data.wrist;
        document.getElementById('gripperValue').textContent = data.gripper;
        
        // æ›´æ–°æ¨¡å¼
        const modes = ['æ‰‹åŠ¨æ¨¡å¼', 'å½•åˆ¶æ¨¡å¼', 'å›æ”¾æ¨¡å¼'];
        document.getElementById('currentMode').textContent = modes[data.mode];
        currentMode = data.mode;
        
        // æ›´æ–°å½•åˆ¶å’Œå›æ”¾çŠ¶æ€
        document.getElementById('isRecording').textContent = data.is_recording ? 'è¿›è¡Œä¸­' : 'æœªå¼€å§‹';
        document.getElementById('isPlaying').textContent = data.is_playing ? 'è¿›è¡Œä¸­' : 'æœªå¼€å§‹';
        
        // æ›´æ–°å½•åˆ¶çŠ¶æ€æŒ‡ç¤ºå™¨
        const recordingStatus = document.getElementById('recordingStatus');
        if (data.is_recording) {
          recordingStatus.textContent = 'å½•åˆ¶ä¸­';
          recordingStatus.className = 'status-badge status-active';
        } else {
          recordingStatus.textContent = 'æœªå¼€å§‹';
          recordingStatus.className = 'status-badge status-inactive';
        }
        
        // æ›´æ–°å›æ”¾çŠ¶æ€æŒ‡ç¤ºå™¨
        const playbackStatus = document.getElementById('playbackStatus');
        if (data.is_playing) {
          playbackStatus.textContent = 'å›æ”¾ä¸­';
          playbackStatus.className = 'status-badge status-active';
        } else {
          playbackStatus.textContent = 'æœªå¼€å§‹';
          playbackStatus.className = 'status-badge status-inactive';
        }
        
        // æ ¹æ®æ¨¡å¼å’Œå½•åˆ¶/å›æ”¾çŠ¶æ€æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateButtonStates(data.mode, data.is_recording, data.is_playing);
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('è·å–çŠ¶æ€å¤±è´¥: ' + error, false);
      });
    }
    
    // æ–°å¢å‡½æ•°ï¼šæ ¹æ®å½“å‰æ¨¡å¼å’ŒçŠ¶æ€æ›´æ–°æ‰€æœ‰æŒ‰é’®çŠ¶æ€
    function updateButtonStates(mode, isRecording, isPlaying) {
      // æ›´æ–°æ¨¡å¼æŒ‰é’®æ ·å¼
      document.getElementById('modeManual').className = mode === 0 ? 'btn-info' : '';
      document.getElementById('modeRecord').className = mode === 1 ? 'btn-warning' : '';
      document.getElementById('modePlayback').className = mode === 2 ? 'btn-info' : '';
      
      // æ˜¾ç¤º/éšè—å¯¹åº”çš„æ§åˆ¶é¢æ¿
      document.getElementById('manualControls').className = mode === 0 ? 'control-container active' : 'control-container';
      document.getElementById('recordControls').className = mode === 1 ? 'control-container active' : 'control-container';
      document.getElementById('playbackControls').className = mode === 2 ? 'control-container active' : 'control-container';
      
      // æ›´æ–°å½•åˆ¶ç›¸å…³æŒ‰é’®çŠ¶æ€ï¼ˆä»…åœ¨å½•åˆ¶æ¨¡å¼ä¸‹å¯ç”¨ï¼‰
      document.getElementById('startRecording').disabled = isRecording;
      document.getElementById('stopRecording').disabled = !isRecording;
      
      // æ›´æ–°å›æ”¾ç›¸å…³æŒ‰é’®çŠ¶æ€ï¼ˆä»…åœ¨å›æ”¾æ¨¡å¼ä¸‹å¯ç”¨ï¼‰
      document.getElementById('startPlayback').disabled = isPlaying;
      document.getElementById('stopPlayback').disabled = !isPlaying;
    }
    
    function sendHome() {
      sendControlCommand({ action: 'home' });
      setTimeout(refreshStatus, 1000);
    }
    
    function setMode(mode) {
      fetch('/api/learning', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: 'set_mode', mode: mode })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          currentMode = mode;
          showMessage(data.message, true);
          // å»¶è¿Ÿåˆ·æ–°çŠ¶æ€ï¼Œç¡®ä¿åç«¯çŠ¶æ€å·²æ›´æ–°
          setTimeout(refreshStatus, 300);
        } else {
          showMessage(data.message, false);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('è®¾ç½®æ¨¡å¼å¤±è´¥: ' + error, false);
      });
    }
    
    function startRecording() {
      sendLearningCommand('start_recording');
    }
    
    function stopRecording() {
      sendLearningCommand('stop_recording');
    }
    
    function startPlayback() {
      const pathIndex = document.getElementById('playbackPathIndexSelect').value;
      sendLearningCommand('start_playback', pathIndex);
    }
    
    function stopPlayback() {
      sendLearningCommand('stop_playback');
    }
    
    function savePath() {
      const pathIndex = document.getElementById('recordPathIndexSelect').value;
      console.log(`å°è¯•ä¿å­˜è·¯å¾„åˆ°ç´¢å¼• ${pathIndex}`);
      
      // æ£€æŸ¥å½“å‰è·¯å¾„æ˜¯å¦æœ‰ç‚¹
      fetch('/api/status')
        .then(response => response.json())
        .then(data => {
          if (data.is_recording) {
            showMessage("è¯·å…ˆåœæ­¢å½•åˆ¶ï¼Œç„¶åå†ä¿å­˜è·¯å¾„", false);
            return;
          }
          
          // ç»§ç»­ä¿å­˜è·¯å¾„
          sendLearningCommand('save_path', pathIndex)
            .then(success => {
              if (success) {
                console.log(`è·¯å¾„${pathIndex}ä¿å­˜æˆåŠŸï¼Œåˆ·æ–°è·¯å¾„åˆ—è¡¨`);
                
                // åˆ‡æ¢åˆ°è·¯å¾„ç®¡ç†é¡µé¢
                document.querySelectorAll('.tablinks').forEach(tab => {
                  tab.classList.remove('active');
                });
                document.querySelectorAll('.tabcontent').forEach(content => {
                  content.style.display = 'none';
                });
                document.getElementById('paths').style.display = 'block';
                document.querySelector('.tablinks[onclick*="paths"]').classList.add('active');
                
                // å»¶è¿Ÿæ›´é•¿æ—¶é—´ï¼Œç¡®ä¿NVSå†™å…¥å®Œæˆ
                setTimeout(() => {
                  updatePathList();
                  showMessage(`è·¯å¾„${pathIndex}ä¿å­˜æˆåŠŸï¼Œå·²æ›´æ–°è·¯å¾„åˆ—è¡¨`, true);
                }, 1500);
              }
            });
        })
        .catch(error => {
          console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
          showMessage('è·å–çŠ¶æ€å¤±è´¥', false);
        });
    }
    
    function loadPath() {
      const pathIndex = document.getElementById('playbackPathIndexSelect').value;
      sendLearningCommand('load_path', pathIndex);
    }
    
    function sendLearningCommand(action, pathIndex = 0) {
      console.log(`å‘é€å­¦ä¹ å‘½ä»¤: ${action}, è·¯å¾„ç´¢å¼•: ${pathIndex}`);
      return fetch('/api/learning', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: action, path_index: parseInt(pathIndex) })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTPé”™è¯¯ ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        showMessage(data.message, data.success);
        if (data.success) {
          // ç«‹å³åˆ·æ–°çŠ¶æ€ï¼Œç¡®ä¿UIä¸åç«¯çŠ¶æ€åŒæ­¥
          setTimeout(refreshStatus, 300);
          return true;
        } else {
          console.warn('æ“ä½œå¤±è´¥: ' + data.message);
          return false;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('æ“ä½œå¤±è´¥: ' + error, false);
        return false;
      });
    }
    
    // æ·»åŠ é‡è¯•æœºåˆ¶çš„updatePathListå‡½æ•°
    function updatePathList(isInitial = false) {
      console.log('å¼€å§‹æ›´æ–°è·¯å¾„åˆ—è¡¨' + (isInitial ? ' (åˆå§‹åŒ–)' : ''));
      const pathList = document.getElementById('pathList');
      pathList.innerHTML = '<div class="loading-indicator">åŠ è½½ä¸­...</div>';
      
      // æ£€æŸ¥æ¯ä¸ªè·¯å¾„æ˜¯å¦å­˜åœ¨
      const pathCheckPromises = [];
      
      for (let i = 0; i < 5; i++) {
        // å°è¯•åŠ è½½è·¯å¾„ä¿¡æ¯
        const promise = fetch(`/api/download_path?idx=${i}`)
          .then(response => {
            console.log(`è·¯å¾„${i}æ£€æŸ¥ç»“æœ: ${response.status}`);
            if (!response.ok) {
              if (response.status === 404) {
                console.log(`è·¯å¾„${i}ä¸å­˜åœ¨`);
                return { exists: false, index: i };
              }
              throw new Error(`HTTPé”™è¯¯ ${response.status}`);
            }
            return response.json().then(data => {
              console.log(`è·¯å¾„${i}å­˜åœ¨ï¼Œç‚¹æ•°é‡: ${data.point_count}`);
              return { 
                exists: true, 
                index: i, 
                data: data,
                pointCount: data.point_count,
                totalTime: data.total_time_ms
              };
            });
          })
          .catch(error => {
            console.error(`æ£€æŸ¥è·¯å¾„${i}æ—¶å‡ºé”™:`, error);
            return { exists: false, index: i, error: error.message };
          });
        
        pathCheckPromises.push(promise);
      }
      
      // ç­‰å¾…æ‰€æœ‰è·¯å¾„æ£€æŸ¥å®Œæˆ
      Promise.all(pathCheckPromises)
        .then(results => {
          pathList.innerHTML = '';
          
          if (results.every(result => !result.exists)) {
            pathList.innerHTML = '<div class="empty-message">æ²¡æœ‰ä¿å­˜çš„è·¯å¾„</div>';
            return;
          }
          
          // æ˜¾ç¤ºè·¯å¾„åˆ—è¡¨
          results.forEach(result => {
            const pathItem = document.createElement('div');
            pathItem.className = 'path-item';
            pathItem.dataset.index = result.index;
            
            // è·¯å¾„æ ‡é¢˜å’ŒçŠ¶æ€
            const pathHeader = document.createElement('div');
            pathHeader.className = 'path-header';
            
            const pathTitle = document.createElement('div');
            pathTitle.className = 'path-title';
            
            const statusIndicator = document.createElement('span');
            statusIndicator.className = `path-status ${result.exists ? 'exists' : 'empty'}`;
            pathTitle.appendChild(statusIndicator);
            
            const titleText = document.createTextNode(`è·¯å¾„ ${result.index}`);
            pathTitle.appendChild(titleText);
            
            pathHeader.appendChild(pathTitle);
            pathItem.appendChild(pathHeader);
            
            // è·¯å¾„ä¿¡æ¯
            if (result.exists) {
              const pathInfo = document.createElement('div');
              pathInfo.className = 'path-info';
              pathInfo.innerHTML = `
                <div>ç‚¹æ•°é‡: <strong>${result.pointCount}</strong></div>
                <div>æ€»æ—¶é•¿: <strong>${(result.totalTime / 1000).toFixed(1)} ç§’</strong></div>
              `;
              pathItem.appendChild(pathInfo);
              
              // é¢„è§ˆå®¹å™¨
              const previewContainer = document.createElement('div');
              previewContainer.className = 'path-preview';
              previewContainer.id = `preview-${result.index}`;
              
              const previewContent = document.createElement('pre');
              // åªæ˜¾ç¤ºå‰3ä¸ªç‚¹å’Œæœ€å1ä¸ªç‚¹
              const points = result.data.points;
              let previewText = '';
              
              if (points.length <= 4) {
                previewText = JSON.stringify(points, null, 2);
              } else {
                const previewPoints = [...points.slice(0, 3), { note: '... ä¸­é—´çœç•¥ ...' }, points[points.length - 1]];
                previewText = JSON.stringify(previewPoints, null, 2);
              }
              
              previewContent.textContent = previewText;
              previewContainer.appendChild(previewContent);
              pathItem.appendChild(previewContainer);
            } else {
              const pathInfo = document.createElement('div');
              pathInfo.className = 'path-info';
              pathInfo.textContent = 'æœªä¿å­˜è·¯å¾„';
              pathItem.appendChild(pathInfo);
            }
            
            // æ“ä½œæŒ‰é’®
            const pathActions = document.createElement('div');
            pathActions.className = 'path-actions';
            
            if (result.exists) {
              // é¢„è§ˆæŒ‰é’®
              const previewBtn = document.createElement('button');
              previewBtn.innerHTML = '<i class="icon">ğŸ‘ï¸</i> é¢„è§ˆ';
              previewBtn.className = 'btn-info';
              previewBtn.onclick = function() { 
                togglePreview(result.index); 
              };
              pathActions.appendChild(previewBtn);
              
              // ä¸‹è½½æŒ‰é’®
              const downloadBtn = document.createElement('button');
              downloadBtn.innerHTML = '<i class="icon">â¬‡ï¸</i> ä¸‹è½½';
              downloadBtn.className = 'btn-info';
              downloadBtn.onclick = function() { downloadPath(result.index); };
              pathActions.appendChild(downloadBtn);
              
              // åˆ é™¤æŒ‰é’®
              const deleteBtn = document.createElement('button');
              deleteBtn.innerHTML = '<i class="icon">ğŸ—‘ï¸</i> åˆ é™¤';
              deleteBtn.className = 'btn-danger';
              deleteBtn.onclick = function() { deletePath(result.index); };
              pathActions.appendChild(deleteBtn);
            } else {
              // ä¸Šä¼ æŒ‰é’®
              const uploadBtn = document.createElement('button');
              uploadBtn.innerHTML = '<i class="icon">â¬†ï¸</i> ä¸Šä¼ åˆ°æ­¤';
              uploadBtn.className = 'btn-info';
              uploadBtn.onclick = function() { 
                document.getElementById('uploadPathIndex').value = result.index;
                // æ»šåŠ¨åˆ°ä¸Šä¼ åŒºåŸŸ
                document.getElementById('dropZone').scrollIntoView({ behavior: 'smooth' });
              };
              pathActions.appendChild(uploadBtn);
            }
            
            pathItem.appendChild(pathActions);
            pathList.appendChild(pathItem);
          });
        })
        .catch(error => {
          console.error('æ›´æ–°è·¯å¾„åˆ—è¡¨å¤±è´¥:', error);
          pathList.innerHTML = `<div class="error-message">åŠ è½½è·¯å¾„åˆ—è¡¨å¤±è´¥: ${error.message}</div>`;
          
          // å¦‚æœæ˜¯åˆå§‹åŒ–åŠ è½½ï¼Œå°è¯•é‡è¯•
          if (isInitial) {
            console.log('3ç§’åé‡è¯•åŠ è½½è·¯å¾„åˆ—è¡¨...');
            setTimeout(() => updatePathList(), 3000);
          }
        });
    }
    
    // åˆ‡æ¢è·¯å¾„é¢„è§ˆ
    function togglePreview(index) {
      const previewElement = document.getElementById(`preview-${index}`);
      if (previewElement.classList.contains('active')) {
        previewElement.classList.remove('active');
      } else {
        previewElement.classList.add('active');
      }
    }
    
    // æ–‡ä»¶æ‹–æ”¾å¤„ç†
    function initDragAndDrop() {
      const dropZone = document.getElementById('dropZone');
      
      // é˜»æ­¢é»˜è®¤æ‹–æ”¾è¡Œä¸º
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      // é«˜äº®æ˜¾ç¤ºæ‹–æ”¾åŒºåŸŸ
      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight() {
        dropZone.classList.add('drag-over');
      }
      
      function unhighlight() {
        dropZone.classList.remove('drag-over');
      }
      
      // å¤„ç†æ‹–æ”¾æ–‡ä»¶
      dropZone.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          handleFiles(files);
        }
      }
    }
    
    // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶
    function handleFileSelect(event) {
      const files = event.target.files;
      handleFiles(files);
    }
    
    // å¤„ç†æ–‡ä»¶
    function handleFiles(files) {
      if (files.length === 0) return;
      
      const file = files[0];
      if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
        showMessage('è¯·é€‰æ‹©JSONæ ¼å¼çš„è·¯å¾„æ–‡ä»¶', false);
        return;
      }
      
      // æ£€æŸ¥æ–‡ä»¶å¤§å°
      const MAX_FILE_SIZE = 30 * 1024; // 30KB
      if (file.size > MAX_FILE_SIZE) {
        showMessage(`æ–‡ä»¶å¤ªå¤§ (${(file.size/1024).toFixed(1)}KB)ï¼Œæœ€å¤§å…è®¸ ${MAX_FILE_SIZE/1024}KB`, false);
        return;
      }
      
      // æ˜¾ç¤ºé€‰æ‹©çš„æ–‡ä»¶åå’Œå¤§å°
      document.getElementById('selectedFileName').textContent = `${file.name} (${(file.size/1024).toFixed(1)}KB)`;
      // å¯ç”¨ä¸Šä¼ æŒ‰é’®
      document.getElementById('uploadButton').disabled = false;
      
      // ä¿å­˜æ–‡ä»¶å¼•ç”¨
      window.selectedPathFile = file;
    }
    
    function uploadPathFile() {
      const file = window.selectedPathFile;
      if (!file) {
        showMessage('è¯·é€‰æ‹©è·¯å¾„æ–‡ä»¶', false);
        return;
      }
      
      const pathIndex = document.getElementById('uploadPathIndex').value;
      
      // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
      showMessage('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶ï¼Œè¯·ç¨å€™...', true);
      document.getElementById('uploadButton').disabled = true;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let content = JSON.parse(e.target.result);
          
          // ç¡®ä¿è·¯å¾„ç´¢å¼•ä¸é€‰æ‹©çš„ä¸€è‡´
          content.path_index = parseInt(pathIndex);
          
          console.log(`å‡†å¤‡ä¸Šä¼ è·¯å¾„${pathIndex}ï¼Œæ–‡ä»¶å¤§å°: ${file.size} å­—èŠ‚`);
          
          // ä¸Šä¼ è·¯å¾„æ–‡ä»¶
          fetch('/api/upload_path', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(content)
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              showMessage(data.message || `è·¯å¾„æˆåŠŸä¸Šä¼ åˆ°ç´¢å¼• ${pathIndex}`, true);
              // æ¸…é™¤æ–‡ä»¶é€‰æ‹©
              document.getElementById('pathFile').value = '';
              document.getElementById('selectedFileName').textContent = '';
              document.getElementById('uploadButton').disabled = true;
              window.selectedPathFile = null;
              // åˆ·æ–°è·¯å¾„åˆ—è¡¨
              setTimeout(updatePathList, 500);
            } else {
              showMessage(data.message || 'è·¯å¾„ä¸Šä¼ å¤±è´¥', false);
              // é‡æ–°å¯ç”¨ä¸Šä¼ æŒ‰é’®
              document.getElementById('uploadButton').disabled = false;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showMessage('ä¸Šä¼ é”™è¯¯: ' + error.message, false);
            // é‡æ–°å¯ç”¨ä¸Šä¼ æŒ‰é’®
            document.getElementById('uploadButton').disabled = false;
          });
        } catch (error) {
          showMessage('æ–‡ä»¶æ ¼å¼é”™è¯¯: ' + error.message, false);
          document.getElementById('uploadButton').disabled = false;
        }
      };
      
      reader.onerror = function() {
        showMessage('è¯»å–æ–‡ä»¶å¤±è´¥', false);
        document.getElementById('uploadButton').disabled = false;
      };
      
      reader.readAsText(file);
    }
    
    function showMessage(message, success) {
      const statusElement = document.getElementById('status-message');
      statusElement.textContent = message;
      statusElement.className = success ? 'success' : 'error';
      statusElement.style.display = 'block';
      
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (window.messageTimeout) {
        clearTimeout(window.messageTimeout);
      }
      
      // 5ç§’åéšè—æ¶ˆæ¯
      window.messageTimeout = setTimeout(() => {
        statusElement.style.display = 'none';
      }, 5000);
    }
    
    function downloadPath(index) {
      window.location.href = `/api/download_path?idx=${index}`;
    }
    
    function deletePath(index) {
      if (confirm(`ç¡®å®šè¦åˆ é™¤è·¯å¾„ ${index} å—?`)) {
        sendLearningCommand('delete_path', index);
        setTimeout(updatePathList, 500);
      }
    }
  </script>
</body>
</html> 